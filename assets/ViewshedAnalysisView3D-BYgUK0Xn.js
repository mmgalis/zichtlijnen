import{qW as Pe,c4 as re,c7 as u,cL as K,dH as we,G as q,e as l,y as d,a as B,S as Q,d1 as oe,Z as m,qX as ct,P as C,u as M,ok as Y,ej as X,c6 as I,eo as D,qY as Ce,c5 as G,cV as E,qZ as me,kf as ut,db as tt,cW as T,op as pt,dD as b,dA as O,q_ as Se,m7 as vt,b7 as fe,d0 as A,mt as _t,kO as le,gX as it,og as ae,qa as U,q$ as ne,r0 as Ve,om as st,qb as ge,dw as Te,d6 as wt,d8 as mt,r1 as ft,oj as be,on as ye,dl as Vt,qe as Fe,r2 as j,du as gt,mn as bt,q8 as yt,r3 as Mt,q5 as Dt,dt as ze,qD as Le,nm as Ot,a6 as J,bu as $t,r4 as he,lh as Ct,r5 as St,q3 as Tt,ck as Ht,hY as xe,cU as Me,r6 as Et,cO as Rt,$ as At,lm as ke,r7 as Pt,r8 as Ft,cR as zt,r9 as Lt,bG as Ue,ra as xt}from"./index-CY8jQoH7.js";import{s as kt}from"./AnalysisView3D-vF0deWJi.js";import{O as Ut,a as It,b as L,e as He,f as jt}from"./ShadedColorMaterial.glsl-bG6trUdA.js";import{O as qt,k as Gt}from"./dragEventPipeline3D-Cr0VR7_F.js";import{f as P}from"./LineVisualElement-CYUNwSeC.js";import{b as Bt,s as ee}from"./sliceToolConfig-ClkvrWp5.js";import{t as at,A as R,j as Wt,u as Kt,o as Jt}from"./MoveManipulation-Ceh7xxja.js";import{G as Nt}from"./ExtendedLineVisualElement-CtMU5uvk.js";import{c as Yt}from"./Laserlines.glsl-BU1p-NQl.js";import{o as Xt,a as Zt,v as Qt,l as ei}from"./analysisViewUtils-CZUO1YIF.js";import{t as ti}from"./ToolIntersector-Bf395WkX.js";import"./vec4f32-CjrfB-0a.js";import"./EngineVisualElement-Knx6WXTk.js";function nt({tiltedUpVector:t,rightVector:e,observerRenderSpace:i},s){const a=Ut(t,e,i,s);return a[12]=0,a[13]=0,a[14]=0,a}function De(t,e,i){const s=u(),a=re(u(),i.basis1,i.basis2);return t.next(qt(e,i.plane)).next(n=>{n.action==="start"&&K(s,n.renderStart);const r=we(It(s,n.renderEnd,i.origin,a));return{...n,deltaAngle:r}})}function rt(t,e){if(t==null)return 0;const{observer:i,target:s}=t,a=e.camera.position,n=Pe(a,i)>Pe(a,s)?i:s;return e.pixelSizeAt(n)}const ii=2,Ie=new q([85,85,85,.5]);let H=class extends Q{constructor(e){super(e),this.visible=!0,this._viewshedCorners={topLeft:u(),topRight:u(),bottomLeft:u(),bottomRight:u(),center:u()},this._arcCenterPoints={top:u(),bottom:u(),left:u(),right:u()},this._parallelCenters={top:u(),bottom:u()}}initialize(){const e={view:this.view,isDecoration:!0,color:this._color,renderOccluded:oe.OccludeAndTransparent},i={...e,width:ii,stipplePattern:pt(2)};this._boundaryLinesVisualElement=new P(e),this._leftArcVisualElement=new P(e),this._rightArcVisualElement=new P(e),this._topArcVisualElement=new P(e),this._bottomArcVisualElement=new P(e),this._centralLongitude=new P(i),this._centralLatitude=new P(i),this.addHandles([m(()=>{const s=this.viewshedComputedData;if(!(s!=null&&s.isValid()))return null;const a=this._offsetScale,n=this._viewshedCorners,r=this._arcCenterPoints,o=this._parallelCenters;return s.cornerPoints(a,n),s.arcCentersPoints(a,r),s.parallelCenterPoints(o),{viewshedComputedData:s,corners:n,arcCenters:r,parallelCenters:o}},s=>{s!=null?(this._forEachVisualElement(a=>a.attached=!0),this._updateVisualElements(s)):this._forEachVisualElement(a=>a.attached=!1)},{initial:!0,equals:ct}),m(()=>{var s;return{visible:this.visible,horFOV:(s=this.viewshedComputedData)==null?void 0:s.horizontalFieldOfView}},({visible:s,horFOV:a},n)=>{s!==(n==null?void 0:n.visible)&&this._forEachVisualElement(r=>r.visible=s),s&&a!==(n==null?void 0:n.horFOV)&&(this._boundaryLinesVisualElement.visible=a!==360)},C),m(()=>this._color,s=>this._forEachVisualElement(a=>a.color=s),C)])}get _color(){var o,c;const e=this.viewshedComputedData;if(e==null)return q.toUnitRGBA(Ie);const i=this.analysisViewData,s=((o=i.tool)==null?void 0:o.active)||i.interactive,a=e===i.selectedViewshedComputedData,n=e.viewshed===((c=i.tool)==null?void 0:c.stagedViewshed),r=s&&(a||n)?this.view.effectiveTheme.accentColor:Ie;return q.toUnitRGBA(r)}get _offsetScale(){return rt(this.viewshedComputedData,this.view)}destroy(){this._boundaryLinesVisualElement=M(this._boundaryLinesVisualElement),this._leftArcVisualElement=M(this._leftArcVisualElement),this._rightArcVisualElement=M(this._rightArcVisualElement),this._topArcVisualElement=M(this._topArcVisualElement),this._bottomArcVisualElement=M(this._bottomArcVisualElement),this._centralLongitude=M(this._centralLongitude),this._centralLatitude=M(this._centralLatitude)}_forEachVisualElement(e){[this._boundaryLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(e)}_updateVisualElements(e){const{viewshedComputedData:i,corners:s,arcCenters:a,parallelCenters:n}=e;this._updateBoundaryLines(s),this._updateBoundaryArcs(i,s,n),this._updateCentralHelperArcs(i,a)}_updateBoundaryLines(e){this._boundaryLinesVisualElement.geometry=[[e.center,e.topLeft],[e.center,e.topRight],[e.center,e.bottomLeft],[e.center,e.bottomRight]]}_updateBoundaryArcs(e,i,s){const{observerRenderSpace:a,rightVector:n,horizontalFieldOfView:r,tiltedUpVector:o}=e,c=b(r),h=u(),p=O();Y(p,c/2,o),X(h,n,p),x(this._leftArcVisualElement,a,i.bottomLeft,i.topLeft,"forward",h),Y(p,-c/2,o),I(h,0,0,0),X(h,n,p),x(this._rightArcVisualElement,a,i.bottomRight,i.topRight,"forward",h);const _=r>180?"backward":"forward";x(this._topArcVisualElement,s.top,i.topRight,i.topLeft,_,o),x(this._bottomArcVisualElement,s.bottom,i.bottomRight,i.bottomLeft,_,o)}_updateCentralHelperArcs(e,i){const s=e.observerRenderSpace,a=e.horizontalFieldOfView>=180?"backward":"forward";x(this._centralLatitude,s,i.right,i.left,a,e.tiltedUpVector),x(this._centralLongitude,s,i.top,i.bottom,"forward",e.leftVector)}};function x(t,e,i,s,a,n,r=5){const o=u();D(o,i,e);const c=Ce(o),h=u();D(h,s,e),G(h,h),E(h,h,c);let p=me(o,h);const _=ut(n);a==="backward"&&(tt(_,_),p=-(2*Math.PI-p));const v=[],f=Math.ceil(Math.abs(p)/b(r)),g=O();Y(g,p/f,_);const y=u();K(y,o);const te=u();K(te,i);for(let Ee=0;Ee<f;Ee++){const Re=u();K(Re,te),X(y,y,g),T(te,e,y);const Ae=u();K(Ae,te),v.push([Re,Ae])}t.geometry=v}l([d()],H.prototype,"view",void 0),l([d()],H.prototype,"analysisViewData",void 0),l([d()],H.prototype,"viewshedComputedData",void 0),l([d()],H.prototype,"visible",void 0),l([d()],H.prototype,"_color",null),l([d()],H.prototype,"_offsetScale",null),H=l([B("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],H);const si=H;let z=class extends Q{get visible(){return this.analysisViewData.visible}constructor(e){super(e)}initialize(){const e=this.analysisViewData,i=Se(()=>this.analysisViewData.viewshedComputedDataHandles,({viewshedComputedData:s})=>{const a=new si({view:this.view,viewshedComputedData:s,analysisViewData:e});return{visualization:a,remove:()=>a.destroy()}});this._viewshedVisualizations=i,this.addHandles([vt(i),m(()=>this.visible,s=>this._viewshedVisualizations.forEach(({visualization:a})=>a.visible=s))])}};l([d({constructOnly:!0})],z.prototype,"analysisViewData",void 0),l([d({constructOnly:!0,nonNullable:!0})],z.prototype,"view",void 0),l([d({constructOnly:!0})],z.prototype,"isDecoration",void 0),l([d()],z.prototype,"visible",null),z=l([B("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],z);var Oe;let w=Oe=class extends Q{constructor(t){super(t)}get observer(){return this.viewshed.observer??new fe}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,u())}get target(){const t=this.targetRenderSpace;return this.renderSpaceToPoint(t,this.observer.spatialReference)}get targetRenderSpace(){const{leftVector:t,northVector:e,upVector:i}=this,s=this.observerRenderSpace,a=this.farDistanceRenderSpace,n=u();return E(n,e,a),k(n,-b(this.heading),i,n),k(n,-b(this.tiltParallelToSurface),t,n),T(n,s,n),n}get targetDirection(){const t=D(u(),this.targetRenderSpace,this.observerRenderSpace);return G(t,t)}get tiltedUpVector(){const t=k(this.upVector,-b(this.tiltParallelToSurface),this.leftVector,u());return G(t,t)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,O())}get upVector(){const t=this._basis;return A(t[8],t[9],t[10])}get northVector(){const t=this._basis;return A(t[4],t[5],t[6])}get leftVector(){const t=this.upVector,e=k(this.northVector,-b(this.heading),t,u());return re(e,t,e)}get rightVector(){return tt(u(),this.leftVector)}clone(){return new Oe({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}isValid(){return this.viewshed.isValid()}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(t,e,i){const{observerRenderSpace:s,targetRenderSpace:a}=this,n=D(N,a,s);return k(n,-b(e),this.leftVector,n),k(n,-b(t),this.tiltedUpVector,n),T(i,n,s)}cornerPoints(t,e){const i=this.observerRenderSpace,s=this.horizontalFieldOfView/2,a=this.verticalFieldOfView/2,n=this.pointOnSphere(-s,a,ui),r=this.pointOnSphere(s,a,pi),o=this.pointOnSphere(-s,-a,vi),c=this.pointOnSphere(s,-a,_i),h=D(li,n,i),p=D(hi,r,i),_=D(di,o,i),v=D(ci,c,i),{horizontalFieldOfView:f}=this,g=ri;je(h,p,n,o,i,t,f,e.topLeft,e.bottomLeft,g);const y=oi;je(v,_,r,c,i,t,f,e.topRight,e.bottomRight,y),E(e.center,T(e.center,y,g),.5)}arcCentersPoints(t,e){const i=this.horizontalFieldOfView/2,s=this.verticalFieldOfView/2,a=this.pointOnSphere(0,s,e.top),n=this.pointOnSphere(0,-s,e.bottom),r=this.pointOnSphere(-i,0,e.left),o=this.pointOnSphere(i,0,e.right),{observerRenderSpace:c}=this;ie(a,c,t),ie(n,c,t),ie(r,c,t),ie(o,c,t)}parallelCenterPoints(t){const e=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin(b(this.verticalFieldOfView/2)),s=E(N,this.tiltedUpVector,i);T(t.top,e,s),D(t.bottom,e,s)}renderSpaceToPoint(t,e){const i=N;return this.renderCoordsHelper.fromRenderCoords(t,i,e),new fe(i[0],i[1],i[2],e)}_pointToRenderSpace(t,e){const i=_t(t.toArray());return this.renderCoordsHelper.toRenderCoords(i,t.spatialReference,e),e}};function je(t,e,i,s,a,n,r,o,c,h){const p=ai(t,e,n,ni);T(h,a,p),qe(i,t,p,n,r,o),qe(s,t,p,n,r,c)}function k(t,e,i,s){return Y(Ge,e,i),X(s,t,Ge)}function ai(t,e,i,s){const a=re(s,t,e);return G(a,a),E(a,a,i),a}function qe(t,e,i,s,a,n){const r=G(N,e);return E(r,r,s),T(n,t,r),a!==0&&a!==360&&T(n,n,i),n}function ie(t,e,i){const s=D(N,t,e);G(s,s),E(s,s,i),T(t,t,s)}l([d()],w.prototype,"renderCoordsHelper",void 0),l([d()],w.prototype,"viewshed",void 0),l([d()],w.prototype,"observer",null),l([d()],w.prototype,"farDistance",null),l([d()],w.prototype,"farDistanceRenderSpace",null),l([d()],w.prototype,"heading",null),l([d()],w.prototype,"tilt",null),l([d()],w.prototype,"tiltParallelToSurface",null),l([d()],w.prototype,"horizontalFieldOfView",null),l([d()],w.prototype,"verticalFieldOfView",null),l([d()],w.prototype,"observerRenderSpace",null),l([d()],w.prototype,"target",null),l([d()],w.prototype,"targetRenderSpace",null),l([d()],w.prototype,"targetDirection",null),l([d()],w.prototype,"tiltedUpVector",null),l([d()],w.prototype,"_basis",null),l([d()],w.prototype,"upVector",null),l([d()],w.prototype,"northVector",null),l([d()],w.prototype,"leftVector",null),l([d()],w.prototype,"rightVector",null),l([d()],w.prototype,"isValid",null),l([d()],w.prototype,"metersPerUnit",null),w=Oe=l([B("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],w);const N=u(),ni=u(),ri=u(),oi=u(),li=u(),hi=u(),di=u(),ci=u(),ui=u(),pi=u(),vi=u(),_i=u(),Ge=O(),ot=Bt,wi=ee*ot,de=5,se=.0025,mi=1,fi=Math.sin(b(2)),Vi=ee/1.5,Be=5,ce=1;let gi=class extends at{constructor(e){super(),this._handles=new le,this._interactive=!0,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._handles=M(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulators=null}get interactive(){return this._interactive}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}createDragPipeline(e,i){const s=Object.values(this._manipulators);return it(s.map(({manipulator:a,side:n})=>ae(a,(r,o,c,h,p)=>{const _=Di(n,i);Z(n)?i.horizontalFieldOfView:i.verticalFieldOfView;const v=o.next(g=>({...g,manipulatorType:R.SCALE,side:n})),f=De(v,this._view,_);e(r,f,c)})))}updateManipulatorsTransform(e){this._forEachManipulatorInfo(i=>this._updateArcManipulatorTransform(i,e))}updateManipulatorVisuals(e){this._forEachManipulatorInfo(i=>this._updateArcManipulatorVisuals(i,e))}_updateArcManipulatorVisuals({manipulator:e,side:i},s){const a=[];if(s!=null){if(i==="left"&&(s.horizontalFieldOfView<ce||s.horizontalFieldOfView>360-ce)||i==="bottom"&&s.verticalFieldOfView<ce)return e.renderObjects=[],void(e.collisionType={type:"line",paths:[]});const[n,r]=bi(i,s,this._unfocusedArcMaterial);a.push(new L(n,U.Unfocused),new L(n.instantiate({material:this._focusedArcMaterial}),U.Focused)),e.collisionType={type:"line",paths:[r]}}e.renderObjects=a,e.radius=10}_updateArcManipulatorTransform({manipulator:e,side:i},s){const a=s.horizontalFieldOfView,n=b(s.verticalFieldOfView/2),r=b(a/2),o=Z(i);e.location=s.observer;const c=O(),h=y=>{ye(c,y,c)};h(ne(F,b(-90))),o||h(Ve(F,n));const p=s.farDistanceRenderSpace;h(st(F,I(We,p,p,p))),h(ge(F,Mi(i))),h(nt(s,F));const _=D(We,s.targetRenderSpace,s.observerRenderSpace);let v,f;if(h(Te(F,_)),o){if(v=r,f=s.tiltedUpVector,a!==0&&a!==360){const y=rt(s,this._view);v+=2*Math.tan(y/(2*s.farDistance))}}else f=s.rightVector,v=n;v*=i==="right"||i==="bottom"?-1:1;const g=Y(F,v,f);g!=null&&h(g),e.modelTransform=c}_updateManipulatorInteractivity(){const e=this.grabbing;this.forEachManipulator(i=>{i.interactive=!e&&this.interactive||i.grabbing})}_createManipulators(){const e=this._createArcManipulator("left"),i=this._createArcManipulator("right"),s=this._createArcManipulator("top"),a=this._createArcManipulator("bottom");this._manipulators={left:e,right:i,top:s,bottom:a};const n=[[a.manipulator,s.manipulator],[e.manipulator,i.manipulator]];n.push(...n.map(([r,o])=>[o,r])),this._handles.add(n.map(([r,o])=>r.events.on("focus-changed",c=>{const h=c.action==="focus";o.hovering=h})))}_createArcManipulator(e){const i={manipulator:new He({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),side:e};return this._updateArcManipulatorVisuals(i),i}_createArcMaterial(e){const i=e?wi:ot,s=new wt({renderOccluded:oe.OccludeAndTransparent,isDecoration:!0,width:i});return this._handles.add(m(()=>q.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>s.setParameters({color:a}),C)),s}forEachManipulator(e){Object.values(this._manipulators).forEach(({manipulator:i})=>e(i,R.SCALE))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach(i=>e(i))}};function bi(t,e,i){const{horizontalFieldOfView:s,verticalFieldOfView:a}=e,n=Z(t),r=b(Vt((n?a:s)/2,0,15)),o=n?1:Math.max(Math.sin(b(90-a/2)),.1),c=lt(-r/2,r/2,o,[-o,0,0]);return[mt(i,c),c]}function lt(t,e,i,s=[0,0,0],a=10){ft(a>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const n=e-t,[r,o,c]=s;if(n<=0||i<=0)return[A(r,o,c+.001),A(r,o,o+-.001)];const h=[],p=n/a;for(let _=0;_<a;_++){let v=t+_*p;_===a-1&&(v=e);const f=Math.cos(v)*i,g=Math.sin(v)*i,y=A(f+r,o,g+c);h.push(y)}return h}function yi(t){switch(t){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}function Mi(t){return yi(t)*Oi}function Z(t){return t==="left"||t==="right"}function Di(t,{observerRenderSpace:e,targetDirection:i,tiltedUpVector:s,rightVector:a}){const n=Z(t)?a:s;return be(e,i,n)}const Oi=Math.PI/2,F=O(),We=u();class ue extends He{constructor(e,i,s,a){super({view:e,autoScaleRenderObjects:!1,worldSized:!0,radius:5}),this._handles=new le,this._setupManipulatorVisual(i,s,a)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e,i,s){const a=this._createMaterial(),n=b(i),r=e?1:Math.sin(n),o=e?lt(0,n,r,[-r,0,0]):[A(0,0,0),A(0,0,r)],c=Fe(a,o,s,16,!1),h=Fe(a,o,s*ee,16,!1),p=Ke(!1,a,s),_=Ke(!0,a,s),v=O();Te(v,o[o.length-1]),j(v,v,Ve(pe,Math.PI/2)),j(v,v,ne(pe,Math.PI/2)),e&&j(v,v,Ve(pe,-n)),p.transformation=v,_.transformation=v,this.renderObjects=[new L(c,U.Unfocused),new L(h,U.Focused),new L(p,U.Unfocused),new L(_,U.Focused)];const f=A(0,ht(!0),0),g=X(f,f,v),y=[...o,g];this.collisionType={type:"line",paths:[y]}}_createMaterial(){const e=new gt({cullFace:bt.Back,renderOccluded:oe.OccludeAndTransparent,isDecoration:!0,writeLinearDepth:!0});return this._handles.add(m(()=>q.toUnitRGBA(this.view.effectiveTheme.accentColor),i=>e.setParameters({color:i}),C)),e}}function Ke(t,e,i){const s=ht(t);let a=2*i;t&&(a*=ee);const n=s/2;return yt(e,s,n,n,a,0)}function ht(t){let e=fi;return t&&(e*=Vi),e}const pe=O();let $i=class extends at{constructor(e){super(),this._handles=new le,this._interactive=!0,this._tool=e.tool,this._view=e.view,this._manipulatorHeading=new ue(this._view,!0,de,se),this._manipulatorTilt=new ue(this._view,!0,de,se),this._manipulatorDistance=new ue(this._view,!1,de,se),this.forEachManipulator(i=>{this._tool.manipulators.add(i),this._handles.add(i.events.on("grab-changed",()=>this._updateManipulatorInteractivity()))})}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}get interactive(){return this._interactive}set interactive(e){this._interactive!==e&&(this._interactive=e,this._updateManipulatorInteractivity())}createHeadingDragPipeline(e,i){return ae(this._manipulatorHeading,(s,a,n,r,o)=>{const{_view:c}=this,h=Math.sin(b(i.tiltParallelToSurface))*i.farDistanceRenderSpace,p=T(ve,i.observerRenderSpace,E(Ye,i.upVector,h)),_=re(Ye,i.northVector,i.upVector),v=be(p,i.northVector,_),f=De(a,c,v).next(g=>({...g,manipulatorType:R.ROTATE}));e(s,f,n)})}createTiltDragPipeline(e,i){return ae(this._manipulatorTilt,(s,a,n,r,o)=>{const c=be(i.observerRenderSpace,i.targetDirection,i.tiltedUpVector),h=De(a,this._view,c).next(p=>({...p,manipulatorType:R.ROTATE}));e(s,h,n)})}createDistanceDragPipeline(e,i){return ae(this._manipulatorDistance,(s,a,n,r,o)=>{const c=Mt(i.observerRenderSpace,i.targetDirection),h=a.next(Dt(this._view,s.location)).next(Gt(this._view,c)).next(p=>({...p,manipulatorType:R.SCALE}));e(s,h,n)})}updateManipulators(e){const{target:i}=e;this._manipulatorHeading.location=i,this._manipulatorTilt.location=i,this._manipulatorDistance.location=i;const s=O(),a=p=>{ye(s,p,s)},n=Ci(e);a(st(W,I(ve,n,n,n))),a(nt(e,W));const r=se*ee*n,o=E(ve,e.targetDirection,r);a(Te(W,o));const c=ge(W,-_e);j(c,c,ne(Ne,-_e)),this._manipulatorHeading.modelTransform=j(O(),s,c);const h=ne(W,_e);j(h,h,ge(Ne,Math.PI)),this._manipulatorTilt.modelTransform=ye(O(),s,h),this._manipulatorDistance.modelTransform=s}_updateManipulatorInteractivity(){const e=!this.grabbing;this.forEachManipulator(i=>{i.interactive=e&&this._interactive||i.grabbing})}forEachManipulator(e){e(this._manipulatorHeading,R.ROTATE),e(this._manipulatorTilt,R.ROTATE),e(this._manipulatorDistance,R.SCALE)}};const Je={top:u(),bottom:u(),left:u(),right:u()},W=O(),Ne=O(),ve=u(),Ye=u(),_e=Math.PI/2;function Ci(t){const{verticalFieldOfView:i,horizontalFieldOfView:s}=t,a=i>180,n=s>180,r=t.farDistanceRenderSpace;if(a&&n)return Math.max(1,r);t.arcCentersPoints(r,Je);const{left:o,right:c,top:h,bottom:p}=Je,_=1.9*(a?ze(o,c):n?ze(p,o):Math.sqrt(Math.min(Le(p,h),Le(o,c))));return Math.max(1,Math.min(r,_))}class dt extends He{constructor(e,i){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:Be,interactive:!1}),this._handles=new le;const s=jt(this._color);this.renderObjects=[new L(Ot(s,Be,32,32))],i.manipulators.add(this),this._handles.add([m(()=>this._color,a=>{s.setParameters({color:a})},C)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return q.toUnitRGBA(this.view.effectiveTheme.accentColor)}}l([d()],dt.prototype,"_color",null);const Xe=Symbol("dragHandles"),Ze=Symbol("hideManipulators");let $=class extends Q{constructor(t){super(t),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._moveHelperVisualElement=null,this._settings=new Wt({getTheme:()=>this.view.effectiveTheme}),this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new gi({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new $i({view:this.view,tool:this.parentTool}),this._observerManipulator=new dt(this.view,this.parentTool),this._createMoveHelperVisuals(),this.addHandles([m(()=>{const{observer:e}=this;return{observer:e,array:e==null?void 0:e.toArray()}},({observer:e})=>{e!=null&&(this._moveManipulation.location=e,this._observerManipulator.location=e)},J),m(()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e==null?void 0:e.observer}},({viewshedComputedData:e,observer:i},s)=>{this._grabbing&&i!==(s==null?void 0:s.observer)||(this.removeHandles(Xe),e!=null&&e.isValid()&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter($t),Xe))},C),m(()=>{const e=this.viewshedComputedData;return e!=null&&e.isValid()?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)},C),m(()=>{const e=this.viewshedComputedData;return e!=null&&e.isValid()?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)},C),m(()=>{var e;return this.analysisViewData.visible&&(((e=this.viewshedComputedData)==null?void 0:e.isValid())??!1)&&!this.parentTool.placingTarget},e=>this._updateManipulationAvailability(e),C),m(()=>{const e=this.viewshedComputedData;if(!(e!=null&&e.isValid()))return null;const{observer:i,target:s,verticalFieldOfView:a,horizontalFieldOfView:n}=e;return{viewshedCompData:e,observer:i,target:s,verticalFieldOfView:a,horizontalFieldOfView:n}},e=>{e!=null&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)},C),m(()=>{var e;return(e=this.viewshedComputedData)==null?void 0:e.observerRenderSpace},e=>{e!=null&&this._updateMoveHelperVisualsLocation(e)},C)]);const t=e=>{this.addHandles([e.events.on("focus-changed",()=>this._updateManipulatorVisibility()),e.events.on("grab-changed",i=>{this._grabbing=i.action==="start"})])};this._forEachManipulator(t)}destroy(){this._moveManipulation=M(this._moveManipulation),this._fieldOfViewManipulation=M(this._fieldOfViewManipulation),this._scaleOrientManipulation=M(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=M(this._observerManipulator),this._destroyMoveHelperVisuals()}get viewshed(){var t;return(t=this.viewshedComputedData)==null?void 0:t.viewshed}get grabbing(){return this._grabbing}get observer(){var t;return(t=this.viewshed)==null?void 0:t.observer}set observer(t){const e=this.viewshed;e!=null&&(e.observer=t)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}onManipulatorSelectionChanged(){this._updateManipulatorVisibility()}hasManipulator(t){let e=!1;return this._forEachManipulator(i=>{e=e||i===t}),e}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new Kt({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:Jt})}_buildObserverDragPipeline(t){const e={mode:"absolute-height",offset:0},i=t.observer;return i==null?null:this._moveManipulation.createDragPipeline((s,a,n,r,o)=>{r=r.next(he(this,["observer"]));const c=t.observer.clone();if(c==null)return{steps:n,cancel:r};const h=Ct.fromGeometry(c,St(this.view.viewingMode));return{steps:n.next(Tt({operations:h})).next(p=>(this.observer=Ht(h.data.geometry,c.spatialReference),p)),cancel:r}},e,i.spatialReference,void 0)}_buildFOVDragPipeline(t){let e=0,i=0;return this._fieldOfViewManipulation.createDragPipeline((s,a,n)=>{if(t==null)return{steps:a,cancel:n};const r=t.viewshed;return n=n.next(he(t,["horizontalFieldOfView","verticalFieldOfView"])),{steps:a.next(o=>{o.action==="start"&&(e=t.horizontalFieldOfView,i=t.verticalFieldOfView);const c=o.deltaAngle;let h=0;switch(o.side){case"left":h=e/2-c;break;case"right":h=e/2+c;break;case"top":h=i+2*c;break;case"bottom":h=i-2*c}return Z(o.side)?(h=xe.normalize(h),h=h>270?0:h>180?180:h,r.horizontalFieldOfView=2*h):r.verticalFieldOfView=h,o}),cancel:n}},t)}_buildScaleOrientDragPipeline(t){let e=0,i=0;const s=(a,n)=>(r,o,c)=>{if(t==null)return{steps:o,cancel:c};const h=t.viewshed;return c=c.next(he(h,[a])),{steps:o=o.next(n(h,t)),cancel:c}};return it([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",(a,n)=>r=>(r.action==="start"&&(i=t.heading),a.heading=xe.normalize(i+r.deltaAngle),r)),t),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",(a,n)=>r=>{r.action==="start"&&(e=t.tilt);let o=e+r.deltaAngle;return o<-90?o=180:o>270&&(o=0),a.tilt=Ti.clamp(o),r}),t),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",(a,n)=>r=>{const o=D(Si,r.renderEnd,n.observerRenderSpace),c=Ce(o)*n.metersPerUnit,h=Me(o,n.targetDirection)<0?mi:c;return a.farDistance=h,r}),t)])}_updateManipulationAvailability(t){this._moveManipulation.available=t,this._fieldOfViewManipulation.available=t,this._scaleOrientManipulation.available=t,this._observerManipulator.available=t}_updateManipulatorVisibility(){const t=this._someManipulatorSelected()||this._someManipulatorHovering()&&this.view.activeTool==null;if(t)this.removeHandles(Ze);else{const e=[],i=s=>{e.push(s.disableDisplay())};this._forEachManipulator(i),this.addHandles(e,Ze)}this._updateMoveHelperVisualsVisibility(t)}_forEachManipulator(t){this._moveManipulation.forEachManipulator(t),this._fieldOfViewManipulation.forEachManipulator(t),this._scaleOrientManipulation.forEachManipulator(t),t(this._observerManipulator)}_createMoveHelperVisuals(){this._destroyMoveHelperVisuals();const t=new Yt({view:this.view,attached:!0,style:{glowWidth:this._settings.visualElements.heightPlane.glowWidth,innerWidth:this._settings.visualElements.heightPlane.innerWidth},isDecoration:!0}),e=new Nt({view:this.view,extensionType:this._settings.visualElements.zVerticalLine.extensionType,attached:!0,innerWidth:1,writeDepthEnabled:!1,renderOccluded:oe.OccludeAndTransparent,isDecoration:!0});this._moveHelperVisualElement={laserline:t,verticalLine:e},this.addHandles([m(()=>this._settings.visualElements.zVerticalLine,i=>i.apply(e),J),m(()=>this._settings.visualElements.heightPlane,i=>i.apply(t),J)])}_updateMoveHelperVisualsVisibility(t){t=this.analysisViewData.visible&&t;const e=this._moveHelperVisualElement;e!=null&&(e.verticalLine.visible=t,e.laserline.visible=t)}_updateMoveHelperVisualsLocation(t){const e=this._moveHelperVisualElement;if(e==null)return;const{laserline:i,verticalLine:s}=e;i.heightManifoldTarget=t,i.intersectsWorldUpAtLocation=t,t!=null&&s.setStartEndFromWorldDownAtLocation(t)}_destroyMoveHelperVisuals(){const t=this._moveHelperVisualElement;t!=null&&(t.laserline.destroy(),t.verticalLine.destroy(),this._moveHelperVisualElement=null)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,moveHelperVisualElements:this._moveHelperVisualElement,viewshedComputedData:this.viewshedComputedData}}};l([d({constructOnly:!0})],$.prototype,"analysis",void 0),l([d({constructOnly:!0})],$.prototype,"analysisViewData",void 0),l([d({constructOnly:!0})],$.prototype,"parentTool",void 0),l([d({constructOnly:!0,nonNullable:!0})],$.prototype,"view",void 0),l([d()],$.prototype,"viewshed",null),l([d()],$.prototype,"_grabbing",void 0),l([d()],$.prototype,"grabbing",null),l([d()],$.prototype,"viewshedComputedData",void 0),l([d()],$.prototype,"observer",null),$=l([B("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],$);const Si=u(),Ti=new Et(0,180);var $e;let V=$e=class extends Xt{constructor(t){super(t),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._creating=!1,this._selectedManipulator=null,this._selectedManipulatorSubTool=null}initialize(){this._intersector=ti(this.view.state.viewingMode);const t=this.analysisViewData.viewshedComputedDataHandles;this.addHandles([m(()=>t.some(e=>e.viewshedComputedData.isValid()),e=>{e&&this.finishToolCreation()},J),m(()=>this._stagedViewshed,e=>{var i;this._stagedViewshedComputedData=e!=null?(i=this.analysisViewData.viewshedComputedDataHandles.find(s=>s.viewshedComputedData.viewshed===e))==null?void 0:i.viewshedComputedData:null},J),m(()=>this.firstGrabbedManipulator,e=>{e!=null&&this._selectManipulator(e)},At),m(()=>this.analysisViewData.visible,e=>{e||this._selectManipulator(null)}),m(()=>this.view.activeTool,e=>{e!==this&&e!=null&&this._selectManipulator(null)})]),this.subToolHandles=Se(()=>t,({viewshedComputedData:e})=>{const i=new $({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:i,remove:()=>{this._selectedManipulatorSubTool===i&&this._selectManipulator(null),i.destroy()}}})}destroy(){this.subToolHandles=M(this.subToolHandles)}onDeactivate(){this.removeStaged()}get cursor(){return this.creating?"crosshair":null}_selectManipulator(t){var i,s,a;const e=this._selectedManipulator;e!=null&&(e.selected=!1,this._selectedManipulator=null,(i=this._selectedManipulatorSubTool)==null||i.onManipulatorSelectionChanged(),this._selectedManipulatorSubTool=null),t!=null&&(t.selected=!0,this._selectedManipulator=t,this._selectedManipulatorSubTool=(s=this.subToolHandles.find(n=>n.subTool.hasManipulator(t)))==null?void 0:s.subTool,(a=this._selectedManipulatorSubTool)==null||a.onManipulatorSelectionChanged())}get selectedViewshed(){var t;return(t=this._selectedManipulatorSubTool)==null?void 0:t.viewshed}set selectedViewshed(t){this.selectViewshed(t)}get selectedViewshedComputedData(){var t;return(t=this._selectedManipulatorSubTool)==null?void 0:t.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:t})=>t.grabbing)}get creating(){return this._creating&&this.active}get placingTarget(){return this._stagedViewshed!=null}createViewsheds(){this._creating=!0}onManipulatorSelectionChanged(){this.subToolHandles.forEach(t=>t.subTool.onManipulatorSelectionChanged())}onInputEvent(t){switch(t.type){case"immediate-click":this._clickDeselectHandler();break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":ke.cancel===t.key?this._cancelKeyHandler(t):ke.delete.includes(t.key)&&this._deleteKeyHandler()}}onInputEventAfter(t){t.type==="immediate-click"&&this._clickPlacementHandler(t)}_clickDeselectHandler(){this.hasFocusedManipulators||this._selectManipulator(null)}_clickPlacementHandler(t){if(!this.creating||this.hasFocusedManipulators)return;const e=this._stagedViewshed,i=this._intersectScreen(t,et);if(i!=null){if(e==null){i.mapPoint.z=(i.mapPoint.z??0)+2;const s=new Pt({observer:i.mapPoint.clone()});this.analysis.viewsheds.add(s),this._stagedViewshed=s,this._updateStagedViewshed(i.scenePoint)}else{this._updateStagedViewshed(i.scenePoint);const s=this._stagedViewshed;this._stagedViewshed=null,this.selectViewshed(s)}t.stopPropagation()}}_doubleClickHandler(t){this.creating&&(this.removeStaged(),this._selectManipulator(null),this._creating=!1,this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(!this.creating||this._stagedViewshed==null)return;const e=this._intersectScreen(t,et);e!=null&&this._updateStagedViewshed(e.scenePoint)}_cancelKeyHandler(t){if(this.creating){if(this.removeStaged())return this._selectManipulator(null),void t.stopPropagation();this._creating=!1}else if(!this.grabbing)return this.selectViewshed(null),void t.stopPropagation()}_deleteKeyHandler(){this.creating&&this.removeStaged(),this.selectedViewshed!=null&&this.analysis.viewsheds.remove(this.selectedViewshed)}_updateStagedViewshed(t){const e=this._stagedViewshed,i=this._stagedViewshedComputedData;if(e==null||i==null)return;const{heading:s,tilt:a,farDistance:n}=Hi(this.view,i,t);e.farDistance=n,e.tilt=a,e.heading=s}removeStaged(){return this._stagedViewshed!=null&&(this.analysis.viewsheds.remove(this._stagedViewshed),this._stagedViewshed=null,!0)}selectViewshed(t){var i;if(t!=null)for(const s of this.view.tools.items)s!==this&&s instanceof $e&&s.selectViewshed(null);const e=(i=this.subToolHandles.find(s=>s.subTool.viewshed===t))==null?void 0:i.subTool;this._selectManipulator(e==null?void 0:e.discManipulator)}_intersectScreen(t,e){const i=Ft(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const s=this._intersector.results.min,a=e.scenePoint;if(!s.getIntersectionPoint(a))return null;const n=e.mapPoint;return n.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(a,n),n==null?null:e}get test(){var t;return{subTools:this.subToolHandles.map(e=>e.subTool.test),selectedSubTool:(t=this._selectedManipulatorSubTool)==null?void 0:t.test,stagedViewshed:this._stagedViewshed}}};function Hi(t,e,i){const s=e.observerRenderSpace,a=D(Ei,i,s),n=Ce(a)*e.metersPerUnit,r=t.renderCoordsHelper.basisMatrixAtPosition(s,Pi),o=I(Ri,r[8],r[9],r[10]),c=zt(s,o,Fi),h=Lt(c,i,Ai),p=D(h,h,s),_=we(me(a,p))*(Me(o,a)<0?-1:1)+90,v=I(Qe,r[4],r[5],r[6]),f=we(me(v,p)),g=I(Qe,r[0],r[1],r[2]);return{heading:Me(p,g)<0?360-f:f,tilt:_,farDistance:n}}l([d({constructOnly:!0})],V.prototype,"view",void 0),l([d()],V.prototype,"analysisViewData",void 0),l([d()],V.prototype,"removeIncompleteOnCancel",void 0),l([d()],V.prototype,"automaticManipulatorSelection",void 0),l([d({constructOnly:!0})],V.prototype,"analysis",void 0),l([d()],V.prototype,"subToolHandles",void 0),l([d()],V.prototype,"_stagedViewshed",void 0),l([d()],V.prototype,"_stagedViewshedComputedData",void 0),l([d()],V.prototype,"_creating",void 0),l([d({readOnly:!0})],V.prototype,"cursor",null),l([d()],V.prototype,"_selectedManipulator",void 0),l([d()],V.prototype,"_selectedManipulatorSubTool",void 0),l([d()],V.prototype,"selectedViewshed",null),l([d()],V.prototype,"selectedViewshedComputedData",null),l([d()],V.prototype,"grabbing",null),l([d()],V.prototype,"creating",null),l([d()],V.prototype,"placingTarget",null),V=$e=l([B("esri.views.3d.analysis.Viewshed.ViewshedTool")],V);const Ei=u(),Ri=u(),Ai=u(),Qe=u(),Pi=O(),Fi=Rt(),et={mapPoint:new fe,scenePoint:u()},zi=V;let S=class extends kt(Q){constructor(t){super(t),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this.viewshedComputedDataHandles=null,this._placementTask=null}get selectedViewshed(){var t;return(t=this.tool)==null?void 0:t.selectedViewshed}set selectedViewshed(t){const{tool:e}=this;e!=null&&(e.selectedViewshed=t)}get selectedViewshedComputedData(){var t;return(t=this.tool)==null?void 0:t.selectedViewshedComputedData}initialize(){this._initializeUpdateHandle(),this.viewshedComputedDataHandles=Se(()=>this.analysis.viewsheds,t=>{const e=new w({renderCoordsHelper:this.view.renderCoordsHelper,viewshed:t}),i=Symbol();return this.addHandles(m(()=>e.isValid(),(s,a)=>{this.visible&&(s?this._addViewshedsToRenderer(e):a&&this._removeViewshedsFromRenderer(e))},C)),{viewshedComputedData:e,remove:()=>{this.removeHandles(i),this._removeViewshedsFromRenderer(e),e.destroy()}}}),this._analysisVisualization=new z({view:this.view,analysisViewData:this,isDecoration:!this.parent}),this.addHandles([m(()=>this.visible,t=>{const e=this.viewshedComputedDataHandles.map(i=>i.viewshedComputedData).filter(i=>i.isValid());t?this._addViewshedsToRenderer(e):this._removeViewshedsFromRenderer(e)}),m(()=>this.view.renderCoordsHelper,t=>{this.viewshedComputedDataHandles.forEach(({viewshedComputedData:e})=>e.renderCoordsHelper=t)}),Zt(this,zi)])}destroy(){this._placementTask=Ue(this._placementTask),Qt(this),this._analysisVisualization=M(this._analysisVisualization),this._removeViewshedsFromRenderer(this.viewshedComputedDataHandles.map(t=>t.viewshedComputedData))}async createViewsheds(t){return this._placementTask=Ue(this._placementTask),this._placementTask=ei(this,t),this.tool!=null&&this.tool.createViewsheds(),await this._placementTask.promise}_initializeUpdateHandle(){const t=this.view._stage.renderer.plugins.plugins.find(e=>e instanceof xt);t&&(this._updateHandleInRenderer=t.updateViewsheds.bind(t))}_addViewshedsToRenderer(t){this._updateHandleInRenderer({adds:t})}_removeViewshedsFromRenderer(t){this._updateHandleInRenderer({removes:t})}};l([d({readOnly:!0})],S.prototype,"type",void 0),l([d({constructOnly:!0,nonNullable:!0})],S.prototype,"analysis",void 0),l([d()],S.prototype,"tool",void 0),l([d()],S.prototype,"selectedViewshed",null),l([d()],S.prototype,"selectedViewshedComputedData",null),l([d()],S.prototype,"viewshedComputedDataHandles",void 0),l([d()],S.prototype,"_analysisVisualization",void 0),l([d()],S.prototype,"_placementTask",void 0),S=l([B("esri.views.3d.analysis.ViewshedAnalysisView3D")],S);const es=S;export{es as default};
